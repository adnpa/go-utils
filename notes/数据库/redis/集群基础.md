# 主从集群



# 哨兵集群



# 分片集群



https://redis.io/docs/latest/operate/oss_and_stack/management/scaling/



## 功能

* 自动在多个节点之间拆分数据集。
* 当部分节点出现故障或无法与集群的其余部分通信时，继续操作。



## Tcp连接

每个节点需要两个TCP连接

* 服务端口，6379，供客户端连接
* cluster bus，节点间交换信息



## Docker

目前，Redis Cluster 不支持 NATted 环境以及重新映射 IP 地址或 TCP 端口的一般环境。

Docker 使用一种称为端口映射的技术：在 Docker 容器内运行的程序可能会暴露一个与程序认为正在使用的端口不同的端口。这对于在同一台服务器上同时使用相同端口运行多个容器非常有用。 

要使 Docker 与 Redis 集群兼容，您需要使用 Docker 的主机网络模式。请参阅 Docker 文档中的 --net=host 选项以了解更多信息。



## Redis Cluster 数据分片

负载均衡

* 每个节点数据相同
  * 加权轮询
* 分片系统，每个节点数据不同
  * [一致性哈希](https://www.xiaolincoding.com/os/8_network_system/hash.html)
  * 哈希槽





## Redis Cluster 主从模型

每个哈希槽都有 1（主节点本身）到 N 个副本（N-1 个附加副本节点）。



## Redis 集群一致性保证

**Redis Cluster 不保证强一致性**。实际上，这意味着在某些情况下，Redis Cluster 可能会丢失系统已向客户端确认的写入。

为什么可能失去数据

1. 使用异步复制
   使用wait命令也可强制使用同步复制，但也不会保证不丢失
2. 发生网络分区（节点间网络断开，脑裂），时间较长，从节点被提升为主节点，向主节点的写请求丢失
   重要配置：节点超时时间







## 配置参数

```
port
dir 
slave of <masterip> <masterport>
```

1. **cluster-enabled <yes/no>**：如果设置为 `yes`，则启用 Redis 集群支持，实例将作为集群节点运行。否则，实例将以常规的单节点模式启动。

2. **cluster-config-file <filename>**：尽管名称为“配置文件”，但该文件不是用户可编辑的，而是 Redis 集群节点在每次状态更改时自动持久化集群配置的文件。该文件列出了集群中的其他节点、它们的状态、持久变量等。通常，在接收到消息后，这个文件会被重写并刷新到磁盘。

3. **cluster-node-timeout <milliseconds>**：Redis 集群节点可以在被视为故障之前的最大不可用时间。如果主节点在指定时间内无法访问，它将被其从节点进行故障转移。此参数还控制 Redis 集群中的其他重要内容，特别是每个节点在指定时间内无法访问大多数主节点时，将停止接受查询。

4. **cluster-slave-validity-factor <factor>**：如果设置为零，从节点将始终认为自己是有效的，因此将始终尝试故障转移主节点，而不考虑与主节点断开连接的时间。如果值为正，则最大断开时间将根据节点超时值乘以指定的因子进行计算。如果节点是从节点，并且与主节点的链接断开超过指定时间，则不会尝试故障转移。例如，如果节点超时设置为 5 秒，有效性因子设置为 10，则从节点如果与主节点断开超过 50 秒，将不会尝试故障转移。请注意，任何非零值可能导致在主节点故障后 Redis 集群不可用，除非有能够故障转移的从节点。在这种情况下，集群将在原主节点重新加入集群时恢复可用性。

5. **cluster-migration-barrier <count>**：主节点与其从节点保持连接的最小数量，以便另一个从节点可以迁移到不再由任何从节点覆盖的主节点。

6. **cluster-require-full-coverage <yes/no>**：如果设置为 `yes`（默认值），则在某些键空间没有任何节点覆盖时，集群将停止接受写入。如果设置为 `no`，即使只有对部分键的请求能够处理，集群仍将继续提供查询服务。

7. **cluster-allow-reads-when-down <yes/no>**：如果设置为 `no`（默认值），当集群被标记为故障时，Redis 集群中的节点将停止处理所有流量，无论是无法访问主节点的法定人数还是未满足完全覆盖。这可以防止从一个对集群变化不了解的节点读取潜在的不一致数据。设置为 `yes` 可以允许在故障状态下从节点读取，这对于希望优先考虑读取可用性的应用程序非常有用，同时仍然希望防止不一致的写入。它也可以用于只有一个或两个分片的 Redis 集群，因为它允许节点在主节点故障但无法自动故障转移时继续处理写入请求。